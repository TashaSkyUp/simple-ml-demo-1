<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React Key Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .layer {
            background: #333;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #0066cc;
        }
        .id-display {
            font-family: monospace;
            color: #0dd;
            font-size: 12px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #444;
            border-radius: 5px;
        }
        .error {
            background: #ff4444;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #44ff44;
            color: black;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>React Key Duplication Test</h1>
    <p>This test verifies that React keys are unique and no duplicate key warnings appear.</p>

    <div class="test-section">
        <h2>Console Check</h2>
        <p>Open browser console (F12) and look for warnings about duplicate keys.</p>
        <div id="console-status"></div>
    </div>

    <div class="test-section">
        <h2>Layer Simulation</h2>
        <div id="react-root"></div>
    </div>

    <div class="test-section">
        <h2>ID Generation Test</h2>
        <button onclick="testIdGeneration()">Generate 10 IDs</button>
        <div id="id-test-result"></div>
    </div>

    <script type="text/babel">
        // Exact same ID generation logic as the React component
        const generateUniqueId = () => {
            // Use crypto.randomUUID if available, otherwise fallback to timestamp + random
            if (typeof crypto !== "undefined" && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            // Fallback for browsers without crypto.randomUUID
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        };

        // Simulate the layer types and structure
        const LayerType = {
            Conv: "conv",
            Pool: "pool"
        };

        // Layer component that mimics the actual architecture
        const Layer = ({ layer, index }) => {
            return (
                <div key={layer.id} className="layer">
                    <div>Layer {index + 1}: {layer.type}</div>
                    <div className="id-display">ID: {layer.id}</div>
                </div>
            );
        };

        // Main component that creates layers like TrainableConvNet
        const LayerTest = () => {
            const [layers, setLayers] = React.useState(() => {
                console.log("Creating initial layers...");
                const initialLayers = [
                    {
                        id: generateUniqueId(),
                        type: LayerType.Conv
                    },
                    {
                        id: generateUniqueId(),
                        type: LayerType.Pool
                    },
                    {
                        id: generateUniqueId(),
                        type: LayerType.Conv
                    },
                    {
                        id: generateUniqueId(),
                        type: LayerType.Pool
                    }
                ];
                console.log("Initial layers created:", initialLayers.map(l => ({ id: l.id, type: l.type })));

                // Check for duplicates
                const ids = initialLayers.map(l => l.id);
                const uniqueIds = new Set(ids);
                if (ids.length !== uniqueIds.size) {
                    console.error("‚ùå DUPLICATE IDs FOUND:", ids);
                } else {
                    console.log("‚úÖ All layer IDs are unique");
                }

                return initialLayers;
            });

            const [renderCount, setRenderCount] = React.useState(0);

            React.useEffect(() => {
                setRenderCount(count => count + 1);
                console.log(`Render #${renderCount + 1}`, layers.map(l => l.id));
            });

            const addLayer = () => {
                const newLayer = {
                    id: generateUniqueId(),
                    type: LayerType.Conv
                };
                console.log("Adding layer:", newLayer);
                setLayers(prev => [...prev, newLayer]);
            };

            const recreateLayers = () => {
                console.log("Recreating layers...");
                const newLayers = [
                    {
                        id: generateUniqueId(),
                        type: LayerType.Conv
                    },
                    {
                        id: generateUniqueId(),
                        type: LayerType.Pool
                    },
                    {
                        id: generateUniqueId(),
                        type: LayerType.Conv
                    },
                    {
                        id: generateUniqueId(),
                        type: LayerType.Pool
                    }
                ];

                const ids = newLayers.map(l => l.id);
                const uniqueIds = new Set(ids);
                if (ids.length !== uniqueIds.size) {
                    console.error("‚ùå DUPLICATE IDs FOUND in recreation:", ids);
                } else {
                    console.log("‚úÖ All recreated layer IDs are unique");
                }

                setLayers(newLayers);
            };

            return (
                <div>
                    <div>
                        <button onClick={addLayer}>Add Layer</button>
                        <button onClick={recreateLayers} style={{marginLeft: '10px'}}>Recreate Layers</button>
                        <span style={{marginLeft: '20px', color: '#888'}}>Renders: {renderCount}</span>
                    </div>
                    <div style={{margin: '20px 0'}}>
                        {layers.map((layer, index) => (
                            <Layer key={layer.id} layer={layer} index={index} />
                        ))}
                    </div>
                </div>
            );
        };

        // Render the test component
        ReactDOM.render(<LayerTest />, document.getElementById('react-root'));

        // Monitor console for warnings
        let hasWarnings = false;
        const originalWarn = console.warn;
        const originalError = console.error;

        console.warn = function(...args) {
            const message = args.join(' ');
            if (message.includes('duplicate') || message.includes('same key')) {
                hasWarnings = true;
                document.getElementById('console-status').innerHTML =
                    '<div class="error">‚ùå DUPLICATE KEY WARNING DETECTED: ' + message + '</div>';
            }
            originalWarn.apply(console, args);
        };

        console.error = function(...args) {
            const message = args.join(' ');
            if (message.includes('duplicate') || message.includes('same key')) {
                hasWarnings = true;
                document.getElementById('console-status').innerHTML =
                    '<div class="error">‚ùå DUPLICATE KEY ERROR DETECTED: ' + message + '</div>';
            }
            originalError.apply(console, args);
        };

        // Check after a short delay
        setTimeout(() => {
            if (!hasWarnings) {
                document.getElementById('console-status').innerHTML =
                    '<div class="success">‚úÖ No duplicate key warnings detected!</div>';
            }
        }, 1000);

        // ID generation test function
        window.testIdGeneration = function() {
            const ids = [];
            const startTime = performance.now();

            for (let i = 0; i < 10; i++) {
                ids.push(generateUniqueId());
            }

            const endTime = performance.now();
            const uniqueIds = new Set(ids);
            const hasDuplicates = ids.length !== uniqueIds.size;

            const result = `
                <div>Generated 10 IDs in ${(endTime - startTime).toFixed(2)}ms</div>
                <div>Unique count: ${uniqueIds.size}/10</div>
                <div class="${hasDuplicates ? 'error' : 'success'}">
                    ${hasDuplicates ? '‚ùå Duplicates found!' : '‚úÖ All IDs unique!'}
                </div>
                <div style="font-family: monospace; margin-top: 10px;">
                    ${ids.map((id, i) => `${i+1}: ${id}`).join('<br>')}
                </div>
            `;

            document.getElementById('id-test-result').innerHTML = result;
        };

        // Auto-run the test
        window.addEventListener('load', () => {
            console.log('üß™ React Key Test Started');
            console.log('Crypto API available:', typeof crypto !== "undefined" && crypto.randomUUID);
        });
    </script>
</body>
</html>
